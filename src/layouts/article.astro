---
import Base from './Base.astro';
import ArticleInfo from '../components/ArticleInfo.astro';
import { themeConfig } from '../../starread.config';

// 从props接收必要的数据
const { entry, wordCount, formatDate } = Astro.props;

// 导入动态组件加载工具函数
import { loadDynamicComponents } from '../utils/dynamicComponents';

// 组件映射配置
const widgetComponents = {
  authorWidget: () => import('../components/AuthorWidget.astro'),
  tag: () => import('../components/TagCloud.astro'),
  toc: () => import('../components/ArticleTOC.astro')
};

// 动态加载启用的组件
const loadedWidgets = await loadDynamicComponents(widgetComponents, themeConfig.sidebar.article);

// 加载评论组件（始终加载）
const { default: Comment } = await import('../components/Comment.astro');
---

<Base title={Astro.props.title}>
  <Fragment slot="head">
    <!--  canonical链接，优先使用永久链接，否则使用slug -->
    <link rel="canonical" href={entry?.data?.permalink || (Astro.url.pathname)} />
  </Fragment>
  
  <Fragment slot="header">
    <ArticleInfo 
      title={entry?.data?.title || Astro.props.title}
      cover={entry?.data?.cover || Astro.props.cover || themeConfig.site.defaultCover}
      date={formatDate?.(entry?.data?.date) || Astro.props.date}
      tags={entry?.data?.tags || Astro.props.tags || []}
      categories={entry?.data?.categories || Astro.props.categories || []}
      wordCount={wordCount || Astro.props.wordCount || 0}
      permalink={entry?.data?.permalink || Astro.props.permalink}
    />
  </Fragment>
  
  <!-- 左侧内容 -->
  <slot />
  <Comment/>
  
  <!-- 右侧边栏 -->
  <Fragment slot="sidebar">
    {loadedWidgets.map(({ key, component: Component }) => (
      <Component key={key} />
    ))}
  </Fragment>
</Base>
