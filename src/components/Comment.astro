<section class="bg-white/70 backdrop-blur-xl border border-white/20 shadow-[0_1px_0_0_rgba(255,255,255,0.6)_inset,0_8px_30px_rgba(0,0,0,0.06)] dark:bg-cyan-950/30 dark:backdrop-blur-xl dark:border-white/10 dark:shadow-[0_1px_0_0_rgba(255,255,255,0.08)_inset,0_8px_30px_rgba(0,0,0,0.35)] rounded-lg shadow-sm p-4">
  <div id="tcomment"></div>
</section>

<!-- 预加载 Twikoo 样式 -->
<link rel="preload" as="style" href="/twikoo.min.css" />
<link rel="stylesheet" href="/twikoo.min.css" />

<!-- 合并脚本 -->
<script is:inline>
  // 获取脚本工具函数
  function getScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.async = true;
      script.onload = () => resolve();
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // Twikoo 初始化配置
  const twikooConfig = {
    envId: 'none',
    el: '#tcomment',
    path: window.location.pathname,
    lang: 'zh-CN',
    onCommentLoaded: () => {
      console.log('✅ Twikoo 评论加载成功');
    }
  };

  // 初始化函数
  const init = () => {
    window.twikoo.init(twikooConfig);
  };

  // 运行函数
  const runFn = () => {
    init();
  };

  // 加载并初始化 Twikoo
  const loadTwikoo = () => {
    if (typeof window.twikoo === 'object') {
      setTimeout(runFn, 0);
    } else {
      getScript('/twikoo.min.js').then(runFn);
    }
  };

  // 首次加载
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadTwikoo);
  } else {
    loadTwikoo();
  }

  // Astro 页面切换支持
  document.addEventListener('astro:page-load', function() {
    console.log('Astro 页面切换，重新初始化 Twikoo');
    loadTwikoo();
  });

  // View Transitions 支持
  document.addEventListener('astro:after-swap', function() {
    console.log('Astro 页面交换完成，重新初始化 Twikoo');
    loadTwikoo();
  });
</script>

<style is:global>
  #tcomment {
    min-height: 200px;
  }
  
  .tk-comments-container {
    opacity: 1 !important;
  }
</style>
