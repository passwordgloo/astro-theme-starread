<section class="bg-white/70 backdrop-blur-xl border border-white/20 shadow-[0_1px_0_0_rgba(255,255,255,0.6)_inset,0_8px_30px_rgba(0,0,0,0.06)] dark:bg-cyan-950/30 dark:backdrop-blur-xl dark:border-white/10 dark:shadow-[0_1px_0_0_rgba(255,255,255,0.08)_inset,0_8px_30px_rgba(0,0,0,0.35)] rounded-lg shadow-sm p-4">
  <div id="tcomment"></div>
</section>

<!-- 预加载 Twikoo 样式 -->
<link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.min.css" />

<!-- 合并脚本 -->
<script is:inline>
  // 首先引入 Twikoo - 使用CDN并优化加载
  (function() {
    // 仅在视口中或即将进入视口时加载
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const script = document.createElement('script');
          // 使用CDN加载，体积更小且可能已被缓存
          script.src = 'https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.min.js';
          script.defer = true;
          script.onload = function() {
            console.log('Twikoo 脚本加载完成');
            initializeTwikoo();
          };
          document.head.appendChild(script);
          observer.disconnect();
        }
      });
    });
    
    const commentSection = document.querySelector('.bg-white\/70');
    if (commentSection) {
      observer.observe(commentSection);
    } else {
      // 降级方案：如果找不到元素，延迟加载
      setTimeout(() => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.min.js';
        script.defer = true;
        script.onload = function() {
          console.log('Twikoo 脚本加载完成');
          initializeTwikoo();
        };
        document.head.appendChild(script);
      }, 1000);
    }
  })();

  // Twikoo 初始化逻辑
  function initializeTwikoo() {
    let isInitializing = false;
    
    function waitForStyles(callback) {
      const checkStyles = () => {
        const styleSheets = Array.from(document.styleSheets);
        const hasTwikooStyles = styleSheets.some(sheet => {
          try {
            const rules = sheet.cssRules || sheet.rules;
            if (!rules) return false;
            return Array.from(rules).some(rule => 
              rule.selectorText && rule.selectorText.includes('tk-')
            );
          } catch (e) {
            return false;
          }
        });
        
        if (hasTwikooStyles) {
          callback();
        } else {
          setTimeout(checkStyles, 100);
        }
      };
      
      checkStyles();
    }
    
    function initTwikoo() {
      if (isInitializing) {
        console.log('Twikoo 正在初始化中...');
        return;
      }
      
      const container = document.getElementById('tcomment');
      if (!container) {
        console.warn('Twikoo 容器未找到，稍后重试...');
        setTimeout(initTwikoo, 100);
        return;
      }
      
      if (typeof window.twikoo === 'undefined') {
        console.log('等待 Twikoo 加载...');
        setTimeout(initTwikoo, 100);
        return;
      }
      
      isInitializing = true;
      
      waitForStyles(() => {
        try {
          container.innerHTML = '';
          
          window.twikoo.init({
            envId: 'none',
            el: '#tcomment',
            path: window.location.pathname,
            lang: 'zh-CN',
            onCommentLoaded: function() {
              console.log('✅ Twikoo 评论加载成功');
              isInitializing = false;
            }
          });
          
          console.log('✅ Twikoo 初始化完成');
        } catch (error) {
          console.error('❌ Twikoo 初始化失败:', error);
          isInitializing = false;
        }
      });
    }
    
    // 首次加载
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTwikoo);
    } else {
      setTimeout(initTwikoo, 100);
    }
    
    // Astro 页面切换
    document.addEventListener('astro:page-load', function() {
      console.log('Astro 页面切换，重新初始化 Twikoo');
      isInitializing = false;
      setTimeout(initTwikoo, 200);
    });
    
    // View Transitions 支持
    document.addEventListener('astro:after-swap', function() {
      console.log('Astro 页面交换完成，重新初始化 Twikoo');
      isInitializing = false;
      setTimeout(initTwikoo, 200);
    });
  }
</script>

<style is:global>
  #tcomment {
    min-height: 200px;
  }
  
  .tk-comments-container {
    opacity: 1 !important;
  }
</style>
