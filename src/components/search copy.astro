---
import { themeConfig } from '../../starread.config';

// å°†ç¯å¢ƒå˜é‡ä¼ é€’ç»™å®¢æˆ·ç«¯
const algoliaConfig = {
  appId: import.meta.env.PUBLIC_ALGOLIA_APP_ID || '',
  apiKey: import.meta.env.PUBLIC_ALGOLIA_SEARCH_KEY || '',
  indexName: import.meta.env.PUBLIC_ALGOLIA_INDEX_NAME || ''
};

// æ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´
const hasCompleteConfig = Boolean(
  algoliaConfig.appId && 
  algoliaConfig.apiKey && 
  algoliaConfig.indexName
);

if (hasCompleteConfig) {
  console.log('âœ… Algoliaé…ç½®å®Œæ•´', {
    appId: algoliaConfig.appId,
    indexName: algoliaConfig.indexName
  });
} else {
  console.warn('âš ï¸ Algoliaé…ç½®ä¸å®Œæ•´');
}
---

<div class="docsearch-container">
  <!-- æœç´¢æŒ‰é’®è§¦å‘å™¨ -->
  <button 
    id="search-toggle"
    class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors focus:outline-none"
    aria-label="æœç´¢"
  >
    <span class="icon-[lucide--search] h-5 w-5 text-gray-700 dark:text-gray-300"></span>
  </button>

  <!-- æœç´¢å¼¹çª— -->
  <div 
    id="search-modal" 
    class="fixed inset-0 z-50 flex items-start justify-center pt-16 px-4 bg-black/60 hidden"
  >
    <div 
      class="w-full max-w-2xl bg-white dark:bg-gray-900 rounded-lg shadow-xl overflow-hidden flex flex-col"
    >
      <!-- æœç´¢å¤´éƒ¨ -->
      <div class="p-4 border-b dark:border-gray-800 flex items-center justify-between">
        <div class="relative w-full">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
            <span class="icon-[lucide--search] h-5 w-5"></span>
          </span>
          <input
            id="search-input"
            type="text"
            placeholder="æœç´¢æ–‡æ¡£ (âŒ˜K)"
            class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-800 border-0 rounded-md text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-blue-500 outline-none"
          />
        </div>
        <button 
          id="search-close"
          class="ml-2 p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
          aria-label="å…³é—­"
        >
          <span class="icon-[lucide--x] h-5 w-5"></span>
        </button>
      </div>

      <!-- æœç´¢å†…å®¹åŒº -->
      <div class="flex-1 overflow-y-auto max-h-[60vh]">
        <!-- åˆå§‹çŠ¶æ€ -->
        <div id="search-initial" class="search-initial-state">
          <div class="text-center py-12">
            <div class="inline-flex items-center justify-center w-16 h-16 mb-4 rounded-full bg-blue-100 dark:bg-blue-900/30">
              <span class="icon-[lucide--search] h-8 w-8 text-blue-600 dark:text-blue-400"></span>
            </div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">æœç´¢æ–‡æ¡£</h3>
            <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto">
              è¾“å…¥å…³é”®è¯æœç´¢æ–‡æ¡£å†…å®¹ï¼Œæ”¯æŒä½¿ç”¨é”®ç›˜è¿›è¡Œå¯¼èˆª
            </p>
            <div class="mt-6 flex justify-center space-x-3">
              <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300 text-xs">âŒ˜K</kbd>
              <span class="text-gray-500 dark:text-gray-400 text-sm">æ‰“å¼€æœç´¢</span>
            </div>
            <!-- è¿æ¥æµ‹è¯• -->
            <button 
              id="test-connection-btn" 
              class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
            >
              æµ‹è¯• Algolia è¿æ¥
            </button>
            <div id="connection-result" class="mt-4 hidden"></div>
          </div>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="search-loading" class="search-loading-state hidden">
          <div class="text-center py-10">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 dark:border-gray-700 border-t-blue-500 mb-4"></div>
            <p class="text-gray-500 dark:text-gray-400">æ­£åœ¨æœç´¢...</p>
          </div>
        </div>

        <!-- æœç´¢ç»“æœ -->
        <div id="search-results" class="search-results-state hidden">
          <div class="search-results-header border-b dark:border-gray-800 px-4 py-2 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
            <span id="search-results-count">æ‰¾åˆ° 0 ä¸ªç»“æœ</span>
            <span class="text-xs" id="search-query"></span>
          </div>
          <div class="p-2 space-y-1" id="search-results-list">
            <!-- æœç´¢ç»“æœå°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
          </div>
          
          <!-- åˆ†é¡µæ§ä»¶ -->
          <div id="search-pagination" class="mt-3 pb-3 flex justify-center items-center gap-2 hidden">
            <button id="prev-page" class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <span class="icon-[lucide--chevron-left] h-4 w-4"></span>
            </button>
            <div id="page-numbers" class="flex gap-1">
              <!-- é¡µç æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="next-page" class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
              <span class="icon-[lucide--chevron-right] h-4 w-4"></span>
            </button>
          </div>
        </div>

        <!-- æ— ç»“æœçŠ¶æ€ -->
        <div id="search-no-results" class="search-no-results hidden">
          <div class="text-center py-12 px-4">
            <div class="inline-flex items-center justify-center w-16 h-16 mb-4 rounded-full bg-gray-100 dark:bg-gray-800">
              <span class="icon-[lucide--circle-help] h-8 w-8 text-gray-500 dark:text-gray-400"></span>
            </div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">æœªæ‰¾åˆ°ç»“æœ</h3>
            <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto">
              æ²¡æœ‰æ‰¾åˆ°ä¸ "<span id="search-no-results-query" class="font-medium"></span>" ç›¸å…³çš„å†…å®¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯
            </p>
            <div class="mt-4">
              <button 
                id="search-clear"
                class="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 rounded-md text-gray-700 dark:text-gray-300 transition-colors"
              >
                æ¸…é™¤æœç´¢
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- åº•éƒ¨æç¤º -->
      <div class="p-3 bg-gray-50 dark:bg-gray-800 border-t dark:border-gray-700 flex flex-wrap items-center justify-between text-xs text-gray-500 dark:text-gray-400 gap-2">
        <div class="flex flex-wrap items-center gap-x-4 gap-y-1">
          <div class="flex items-center gap-1">
            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300">âŒ˜K</kbd>
            <span>æ‰“å¼€æœç´¢</span>
          </div>
          <div class="flex items-center gap-1">
            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300">â†“</kbd>
            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300">â†‘</kbd>
            <span>æµè§ˆç»“æœ</span>
          </div>
          <div class="flex items-center gap-1">
            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300">Enter</kbd>
            <span>é€‰æ‹©</span>
          </div>
          <div class="flex items-center gap-1">
            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300">Esc</kbd>
            <span>å…³é—­</span>
          </div>
        </div>
        <div class="flex items-center gap-1">
          <span id="search-provider">æœ¬åœ°æœç´¢</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å¼•å…¥ Algolia å®¢æˆ·ç«¯ -->
<script is:inline src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>

<script define:vars={{ algoliaConfig }}>
  (function() {
    if (window.__searchInitialized) return;
    window.__searchInitialized = true;

    // DOM å…ƒç´ 
    const searchToggle = document.getElementById('search-toggle');
    const searchModal = document.getElementById('search-modal');
    const searchInput = document.getElementById('search-input');
    const searchClose = document.getElementById('search-close');
    const searchClear = document.getElementById('search-clear');
    const initialState = document.getElementById('search-initial');
    const loadingState = document.getElementById('search-loading');
    const resultsState = document.getElementById('search-results');
    const noResultsState = document.getElementById('search-no-results');
    const resultsList = document.getElementById('search-results-list');
    const resultsCount = document.getElementById('search-results-count');
    const searchQueryDisplay = document.getElementById('search-query');
    const noResultsQuery = document.getElementById('search-no-results-query');
    const paginationContainer = document.getElementById('search-pagination');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageNumbers = document.getElementById('page-numbers');
    const searchProvider = document.getElementById('search-provider');
    const testConnectionBtn = document.getElementById('test-connection-btn');
    const connectionResult = document.getElementById('connection-result');

    let searchClient = null;
    let searchIndex = null;
    let isOpen = false;
    let currentQuery = '';
    let currentPage = 0;
    let totalPages = 0;
    let totalHits = 0;
    let currentResultIndex = -1;
    let searchTimeout = null;
    const hitsPerPage = 10;

    // æ£€æŸ¥é…ç½®
    const hasConfig = Boolean(
      algoliaConfig.appId && 
      algoliaConfig.apiKey && 
      algoliaConfig.indexName
    );

    console.log('å®¢æˆ·ç«¯ Algolia é…ç½®:', {
      appId: algoliaConfig.appId,
      hasApiKey: Boolean(algoliaConfig.apiKey),
      indexName: algoliaConfig.indexName,
      isComplete: hasConfig
    });

    // åˆå§‹åŒ– Algolia å®¢æˆ·ç«¯
    function initializeAlgolia() {
      if (!hasConfig) {
        console.warn('Algolia é…ç½®ä¸å®Œæ•´');
        return false;
      }

      try {
        searchClient = algoliasearch(
          algoliaConfig.appId,
          algoliaConfig.apiKey
        );
        searchIndex = searchClient.initIndex(algoliaConfig.indexName);
        
        searchProvider.innerHTML = 'ç”± <span class="text-blue-500 font-medium">Algolia</span> æä¾›æ”¯æŒ';
        console.log('âœ… Algolia å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
        return true;
      } catch (error) {
        console.error('âŒ Algolia åˆå§‹åŒ–å¤±è´¥:', error);
        return false;
      }
    }

    // é«˜äº®æœç´¢è¯
    function highlightText(text, query) {
      if (!query || !text) return text;
      
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark class="bg-yellow-200 dark:bg-yellow-700 text-gray-900 dark:text-white font-medium">\$1</mark>');
    }

// æ¸²æŸ“æœç´¢ç»“æœ
function renderResults(hits) {
  resultsList.innerHTML = '';
  
  hits.forEach((hit, index) => {
    const div = document.createElement('div');
    div.className = 'search-result-item p-3 rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition-colors border-l-2 border-transparent';
    div.dataset.index = index;
    div.dataset.url = hit.url || hit.objectID;
    
    // ä½¿ç”¨ Algolia çš„é«˜äº®æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
    const title = hit._highlightResult?.title?.value || hit.title || 'æ— æ ‡é¢˜';
    const content = hit._snippetResult?.content?.value || hit._highlightResult?.content?.value || hit.content || '';
    
    // è·å–å°é¢å›¾ç‰‡
    const coverUrl = hit.cover || hit.image || '';
    
    div.innerHTML = `
      <div class="flex gap-3">
        ${coverUrl ? `
          <div class="flex-shrink-0">
            <img 
              src="${coverUrl}" 
              alt="${hit.title || 'å°é¢'}"
              class="w-20 h-20 object-cover rounded-md"
              onerror="this.style.display='none'"
            />
          </div>
        ` : `
          <div class="flex-shrink-0 w-20 h-20 bg-gray-100 dark:bg-gray-800 rounded-md flex items-center justify-center">
            <span class="icon-[lucide--file-text] h-8 w-8 text-gray-400"></span>
          </div>
        `}
        
        <div class="flex-1 min-w-0">
          <h4 class="font-medium text-gray-900 dark:text-white mb-1 line-clamp-1">
            ${title}
          </h4>
          <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-1">
            ${content}
          </p>
          ${hit.url ? `
            <span class="text-xs text-blue-500 hover:text-blue-600 inline-flex items-center gap-1">
              æŸ¥çœ‹è¯¦æƒ…
              <span class="icon-[lucide--arrow-right] h-3 w-3"></span>
            </span>
          ` : ''}
        </div>
      </div>
    `;
    
    // ç‚¹å‡»äº‹ä»¶
    div.addEventListener('click', () => {
      if (hit.url) {
        window.location.href = hit.url;
      }
    });
    
    // é¼ æ ‡æ‚¬åœäº‹ä»¶
    div.addEventListener('mouseenter', () => {
      setActiveResult(index);
    });
    
    resultsList.appendChild(div);
  });
}

    // è®¾ç½®æ´»åŠ¨ç»“æœ
    function setActiveResult(index) {
      const items = resultsList.querySelectorAll('.search-result-item');
      items.forEach((item, i) => {
        if (i === index) {
          item.classList.add('bg-gray-100', 'dark:bg-gray-800', 'border-blue-500');
          currentResultIndex = index;
          // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
          item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
          item.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'border-blue-500');
        }
      });
    }

    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination() {
      if (totalPages <= 1) {
        paginationContainer.classList.add('hidden');
        return;
      }

      paginationContainer.classList.remove('hidden');
      pageNumbers.innerHTML = '';

      // ä¸Šä¸€é¡µæŒ‰é’®çŠ¶æ€
      prevPageBtn.disabled = currentPage === 0;
      
      // ä¸‹ä¸€é¡µæŒ‰é’®çŠ¶æ€
      nextPageBtn.disabled = currentPage >= totalPages - 1;

      // é¡µç æŒ‰é’®ï¼ˆæœ€å¤šæ˜¾ç¤º7ä¸ªï¼‰
      const maxButtons = 7;
      let startPage = Math.max(0, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages - 1, startPage + maxButtons - 1);
      
      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(0, endPage - maxButtons + 1);
      }

      // ç¬¬ä¸€é¡µ
      if (startPage > 0) {
        addPageButton(0);
        if (startPage > 1) {
          pageNumbers.appendChild(createEllipsis());
        }
      }

      // ä¸­é—´é¡µç 
      for (let i = startPage; i <= endPage; i++) {
        addPageButton(i);
      }

      // æœ€åä¸€é¡µ
      if (endPage < totalPages - 1) {
        if (endPage < totalPages - 2) {
          pageNumbers.appendChild(createEllipsis());
        }
        addPageButton(totalPages - 1);
      }
    }

    function addPageButton(pageNum) {
      const button = document.createElement('button');
      button.textContent = pageNum + 1;
      button.className = `px-3 py-1 rounded text-sm transition-colors ${
        pageNum === currentPage
          ? 'bg-blue-500 text-white'
          : 'bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300'
      }`;
      
      button.addEventListener('click', () => {
        currentPage = pageNum;
        performSearch(currentQuery);
      });
      
      pageNumbers.appendChild(button);
    }

    function createEllipsis() {
      const span = document.createElement('span');
      span.textContent = '...';
      span.className = 'px-2 text-gray-500';
      return span;
    }

    // æ‰§è¡Œæœç´¢
    async function performSearch(query) {
      if (!searchIndex) {
        console.warn('æœç´¢ç´¢å¼•æœªåˆå§‹åŒ–');
        return;
      }

      currentQuery = query;

      // ç©ºæŸ¥è¯¢æ˜¾ç¤ºåˆå§‹çŠ¶æ€
      if (!query.trim()) {
        showInitialState();
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showLoadingState();

      try {
        const result = await searchIndex.search(query, {
          page: currentPage,
          hitsPerPage: hitsPerPage,
          attributesToSnippet: ['content:30'],
          snippetEllipsisText: '...',
        });

        totalHits = result.nbHits;
        totalPages = result.nbPages;

        console.log('æœç´¢ç»“æœ:', {
          query,
          page: currentPage + 1,
          totalPages,
          totalHits,
          hits: result.hits.length
        });

        if (result.hits.length > 0) {
          showResultsState(result.hits, query);
        } else {
          showNoResultsState(query);
        }
      } catch (error) {
        console.error('æœç´¢å¤±è´¥:', error);
        showNoResultsState(query);
      }
    }

    // çŠ¶æ€åˆ‡æ¢å‡½æ•°
    function showInitialState() {
      initialState.classList.remove('hidden');
      loadingState.classList.add('hidden');
      resultsState.classList.add('hidden');
      noResultsState.classList.add('hidden');
      currentResultIndex = -1;
    }

    function showLoadingState() {
      initialState.classList.add('hidden');
      loadingState.classList.remove('hidden');
      resultsState.classList.add('hidden');
      noResultsState.classList.add('hidden');
    }

    function showResultsState(hits, query) {
      initialState.classList.add('hidden');
      loadingState.classList.add('hidden');
      resultsState.classList.remove('hidden');
      noResultsState.classList.add('hidden');

      resultsCount.textContent = `æ‰¾åˆ° ${totalHits} ä¸ªç»“æœ`;
      searchQueryDisplay.textContent = `"${query}"`;
      
      renderResults(hits);
      renderPagination();
      currentResultIndex = -1;
    }

    function showNoResultsState(query) {
      initialState.classList.add('hidden');
      loadingState.classList.add('hidden');
      resultsState.classList.add('hidden');
      noResultsState.classList.remove('hidden');

      noResultsQuery.textContent = query;
    }

    // æµ‹è¯•è¿æ¥
    async function testConnection() {
      if (!hasConfig) {
        showConnectionResult('error', 'é…ç½®ä¸å®Œæ•´', 'appIdã€apiKey æˆ– indexName ç¼ºå¤±');
        return;
      }

      showConnectionResult('loading', 'æ­£åœ¨æµ‹è¯•è¿æ¥...');

      try {
        if (!searchClient) {
          initializeAlgolia();
        }

        const startTime = Date.now();
        const result = await searchIndex.search('', { hitsPerPage: 0 });
        const responseTime = Date.now() - startTime;

        showConnectionResult(
          'success',
          'è¿æ¥æˆåŠŸï¼',
          `ç´¢å¼•ã€Œ${algoliaConfig.indexName}ã€åŒ…å« ${result.nbHits} æ¡è®°å½•ï¼Œå“åº”æ—¶é—´: ${responseTime}ms`
        );

        console.log('ğŸ‰ Algolia è¿æ¥æµ‹è¯•æˆåŠŸ:', {
          indexName: algoliaConfig.indexName,
          totalRecords: result.nbHits,
          responseTime: `${responseTime}ms`
        });
      } catch (error) {
        let errorMsg = 'æœªçŸ¥é”™è¯¯';
        let errorDetail = error.message;

        if (error.status === 403) {
          errorMsg = 'è®¤è¯å¤±è´¥';
          errorDetail = 'API Key æˆ– App ID æ— æ•ˆ';
        } else if (error.status === 404) {
          errorMsg = 'ç´¢å¼•æœªæ‰¾åˆ°';
          errorDetail = `ç´¢å¼•ã€Œ${algoliaConfig.indexName}ã€ä¸å­˜åœ¨`;
        }

        showConnectionResult('error', errorMsg, errorDetail);
        console.error('âŒ Algolia è¿æ¥æµ‹è¯•å¤±è´¥:', error);
      }
    }

    function showConnectionResult(status, message, detail = '') {
      connectionResult.classList.remove('hidden');
      
      const icons = {
        loading: '<span class="icon-[lucide--loader-2] h-5 w-5 text-blue-500 animate-spin"></span>',
        success: '<span class="icon-[lucide--check-circle] h-5 w-5 text-green-500"></span>',
        error: '<span class="icon-[lucide--alert-circle] h-5 w-5 text-red-500"></span>'
      };

      const colors = {
        loading: 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800',
        success: 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800',
        error: 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800'
      };

      connectionResult.className = `mt-4 p-4 rounded-md border ${colors[status]}`;
      connectionResult.innerHTML = `
        <div class="flex items-start gap-3">
          ${icons[status]}
          <div class="flex-1">
            <p class="font-medium text-gray-900 dark:text-white">${message}</p>
            ${detail ? `<p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${detail}</p>` : ''}
          </div>
        </div>
      `;
    }

    // æ‰“å¼€/å…³é—­æœç´¢
    function openSearch() {
      isOpen = true;
      searchModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      searchInput.focus();
      showInitialState();
    }

    function closeSearch() {
      isOpen = false;
      searchModal.classList.add('hidden');
      document.body.style.overflow = '';
      searchInput.value = '';
      currentPage = 0;
      currentQuery = '';
      showInitialState();
    }

    // æœç´¢è¾“å…¥å¤„ç†ï¼ˆé˜²æŠ–ï¼‰
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      
      if (!query) {
        showInitialState();
        return;
      }

      searchTimeout = setTimeout(() => {
        currentPage = 0; // æ–°æœç´¢é‡ç½®é¡µç 
        performSearch(query);
      }, 300);
    });

    // é”®ç›˜å¯¼èˆª
    searchInput.addEventListener('keydown', (e) => {
      const items = resultsList.querySelectorAll('.search-result-item');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (items.length > 0) {
          currentResultIndex = Math.min(currentResultIndex + 1, items.length - 1);
          setActiveResult(currentResultIndex);
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (items.length > 0) {
          currentResultIndex = Math.max(currentResultIndex - 1, 0);
          setActiveResult(currentResultIndex);
        }
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentResultIndex >= 0 && items[currentResultIndex]) {
          items[currentResultIndex].click();
        }
      }
    });

    // åˆ†é¡µæŒ‰é’®äº‹ä»¶
    prevPageBtn.addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        performSearch(currentQuery);
      }
    });

    nextPageBtn.addEventListener('click', () => {
      if (currentPage < totalPages - 1) {
        currentPage++;
        performSearch(currentQuery);
      }
    });

    // äº‹ä»¶ç»‘å®š
    searchToggle?.addEventListener('click', openSearch);
    searchClose?.addEventListener('click', closeSearch);
    searchClear?.addEventListener('click', () => {
      searchInput.value = '';
      showInitialState();
    });
    testConnectionBtn?.addEventListener('click', testConnection);
    
    searchModal?.addEventListener('click', (e) => {
      if (e.target === searchModal) closeSearch();
    });

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        isOpen ? closeSearch() : openSearch();
      }
      if (e.key === 'Escape' && isOpen) {
        closeSearch();
      }
    });

    // åˆå§‹åŒ–
    if (hasConfig) {
      initializeAlgolia();
      // è‡ªåŠ¨æµ‹è¯•è¿æ¥
      setTimeout(testConnection, 1000);
    } else {
      console.warn('âš ï¸ Algolia é…ç½®ä¸å®Œæ•´ï¼Œæœç´¢åŠŸèƒ½ä¸å¯ç”¨');
      searchProvider.textContent = 'æœç´¢é…ç½®ä¸å®Œæ•´';
    }
  })();
</script>

<style>
  /* é«˜äº®æ ·å¼ */
  mark {
    padding: 0 2px;
    border-radius: 2px;
  }

  /* æœç´¢ç»“æœé¡¹åŠ¨ç”» */
  .search-result-item {
    animation: fadeIn 0.2s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* æ»šåŠ¨æ¡æ ·å¼ */
  .overflow-y-auto::-webkit-scrollbar {
    width: 6px;
  }

  .overflow-y-auto::-webkit-scrollbar-track {
    background: transparent;
  }

  .overflow-y-auto::-webkit-scrollbar-thumb {
    background: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
  }

  .dark .overflow-y-auto::-webkit-scrollbar-thumb {
    background: rgba(75, 85, 99, 0.5);
  }
</style>
