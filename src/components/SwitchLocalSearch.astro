---
import { themeConfig } from '../../starread.config';
---

<div class="docsearch-container">
  <!-- æœç´¢æŒ‰é’®è§¦å‘å™¨ -->
  <button 
    id="local-search-toggle"
    class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors focus:outline-none"
    aria-label="æœç´¢"
  >
    <span class="icon-[lucide--search] h-5 w-5 text-gray-700 dark:text-gray-300"></span>
  </button>

  <!-- æœç´¢å¼¹çª— -->
  <div 
    id="local-search-modal" 
    class="fixed inset-0 z-50 flex items-start justify-center pt-16 px-4 bg-black/60 hidden"
  >
    <div 
      class="w-full max-w-2xl bg-white dark:bg-gray-900 rounded-lg shadow-xl overflow-hidden flex flex-col"
    >
      <!-- æœç´¢å¤´éƒ¨ -->
      <div class="p-4 border-b dark:border-gray-800 flex items-center justify-between">
        <div class="relative w-full">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
            <span class="icon-[lucide--search] h-5 w-5"></span>
          </span>
          <input
            id="local-search-input"
            type="text"
            placeholder="æœç´¢æ–‡æ¡£ (âŒ˜K)"
            class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-800 border-0 rounded-md text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-blue-500 outline-none"
          />
        </div>
        <button 
          id="local-search-close"
          class="ml-2 p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
          aria-label="å…³é—­"
        >
          <span class="icon-[lucide--x] h-5 w-5"></span>
        </button>
      </div>

      <!-- æœç´¢å†…å®¹åŒº -->
      <div class="flex-1 overflow-y-auto max-h-[60vh]">
        <!-- åˆå§‹çŠ¶æ€ -->
        <div id="local-search-initial" class="search-initial-state">
          <div class="text-center py-12">
            <div class="inline-flex items-center justify-center w-16 h-16 mb-4 rounded-full bg-blue-100 dark:bg-blue-900/30">
              <span class="icon-[lucide--search] h-8 w-8 text-blue-600 dark:text-blue-400"></span>
            </div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">æœç´¢æ–‡æ¡£</h3>
            <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto">
              è¾“å…¥å…³é”®è¯æœç´¢æ–‡æ¡£å†…å®¹ï¼Œæ”¯æŒä½¿ç”¨é”®ç›˜è¿›è¡Œå¯¼èˆª
            </p>
            <div class="mt-6 flex justify-center space-x-3">
              <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300 text-xs">âŒ˜K</kbd>
              <span class="text-gray-500 dark:text-gray-400 text-sm">æ‰“å¼€æœç´¢</span>
            </div>
          </div>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="local-search-loading" class="search-loading-state hidden">
          <div class="text-center py-10">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 dark:border-gray-700 border-t-blue-500 mb-4"></div>
            <p class="text-gray-500 dark:text-gray-400">æ­£åœ¨æœç´¢...</p>
          </div>
        </div>

        <!-- æœç´¢ç»“æœ -->
        <div id="local-search-results" class="search-results-state hidden">
          <div class="search-results-header border-b dark:border-gray-800 px-4 py-2 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
            <span id="local-search-results-count">æ‰¾åˆ° 0 ä¸ªç»“æœ</span>
            <span class="text-xs" id="local-search-query"></span>
          </div>
          <div class="p-2 space-y-1" id="local-search-results-list">
            <!-- æœç´¢ç»“æœå°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
          </div>
          
          <!-- åˆ†é¡µæ§ä»¶ -->
          <div id="local-search-pagination" class="mt-3 text-center pb-3 hidden">
            <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
          </div>
        </div>

        <!-- æ— ç»“æœçŠ¶æ€ -->
        <div id="local-search-no-results" class="search-no-results hidden">
          <div class="text-center py-12 px-4">
            <div class="inline-flex items-center justify-center w-16 h-16 mb-4 rounded-full bg-gray-100 dark:bg-gray-800">
              <span class="icon-[lucide--circle-help] h-8 w-8 text-gray-500 dark:text-gray-400"></span>
            </div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">æœªæ‰¾åˆ°ç»“æœ</h3>
            <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto">
              æ²¡æœ‰æ‰¾åˆ°ä¸ "<span id="local-search-no-results-query" class="font-medium"></span>" ç›¸å…³çš„å†…å®¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯
            </p>
            <div class="mt-4">
              <button 
                id="local-search-clear"
                class="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 rounded-md text-gray-700 dark:text-gray-300 transition-colors"
              >
                æ¸…é™¤æœç´¢
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- åº•éƒ¨æç¤º -->
      <div class="p-3 bg-gray-50 dark:bg-gray-800 border-t dark:border-gray-700 flex flex-wrap items-center justify-between text-xs text-gray-500 dark:text-gray-400 gap-2">
        <div class="flex flex-wrap items-center gap-x-4 gap-y-1">
          <div class="flex items-center gap-1">
            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300">âŒ˜K</kbd>
            <span>æ‰“å¼€æœç´¢</span>
          </div>
          <div class="flex items-center gap-1">
            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300">â†“</kbd>
            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300">â†‘</kbd>
            <span>æµè§ˆç»“æœ</span>
          </div>
          <div class="flex items-center gap-1">
            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300">Enter</kbd>
            <span>é€‰æ‹©</span>
          </div>
          <div class="flex items-center gap-1">
            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-gray-700 dark:text-gray-300">Esc</kbd>
            <span>å…³é—­</span>
          </div>
        </div>
        <div class="flex items-center gap-1">
          <span>æœ¬åœ°æœç´¢</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å‰ç«¯äº¤äº’è„šæœ¬ -->
<script is:inline>
  // ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼(IIFE)æ¥éš”ç¦»å˜é‡ä½œç”¨åŸŸ
  (function() {
    // ç¡®ä¿è„šæœ¬åªæ‰§è¡Œä¸€æ¬¡
    if (window.__localSearchInitialized) return;
    window.__localSearchInitialized = true;

    // æœç´¢ç›¸å…³çŠ¶æ€
    let isOpen = false;
    let searchQuery = '';
    let searchResults = [];
    let isSearching = false;
    let currentResultIndex = -1;
    let currentPage = 1;
    let paginationInfo = {
      currentPage: 1,
      totalPages: 0,
      hitsPerPage: 5,
      nbHits: 0
    };

    // DOMå…ƒç´ å¼•ç”¨
    const searchToggle = document.getElementById('local-search-toggle');
    const searchModal = document.getElementById('local-search-modal');
    const searchInput = document.getElementById('local-search-input');
    const searchClose = document.getElementById('local-search-close');
    const searchClear = document.getElementById('local-search-clear');
    const initialState = document.getElementById('local-search-initial');
    const loadingState = document.getElementById('local-search-loading');
    const resultsState = document.getElementById('local-search-results');
    const noResultsState = document.getElementById('local-search-no-results');
    const resultsList = document.getElementById('local-search-results-list');
    const resultsCount = document.getElementById('local-search-results-count');
    const searchQueryDisplay = document.getElementById('local-search-query');
    const noResultsQuery = document.getElementById('local-search-no-results-query');
    const paginationContainer = document.getElementById('local-search-pagination');

    // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
    const escapeRegExp = (string) => {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    };

    // æ ¼å¼åŒ–åˆ†ç±»
    const formatCategories = (categories) => {
      if (!categories) return '';
      return Array.isArray(categories) ? categories.join(' / ') : categories;
    };

    // æ ¼å¼åŒ–æ ‡ç­¾
    const formatTags = (tags) => {
      if (!tags) return [];
      return Array.isArray(tags) ? tags : tags.split(',').map(tag => tag.trim());
    };

    // æ¸²æŸ“é«˜äº®æ ‡é¢˜
    const renderHighlightedTitle = (hit, query) => {
      if (!query) return hit.title || 'æœªå‘½åæ–‡æ¡£';
      const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
      return hit.title ? hit.title.replace(regex, '<mark>$1</mark>') : 'æœªå‘½åæ–‡æ¡£';
    };

    // æ¸²æŸ“é«˜äº®å†…å®¹
    const renderHighlightedContent = (hit, query) => {
      if (!hit.content) return '';
      if (!query) return hit.content.split('\n').slice(0, 2).join(' ');
      const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
      return hit.content.replace(regex, '<mark>$1</mark>');
    };

    // è®¡ç®—å¯è§é¡µç 
    const getVisiblePages = () => {
      const total = paginationInfo.totalPages;
      const current = paginationInfo.currentPage;
      const pages = [];
      
      if (total <= 5) {
        // æ€»é¡µæ•°å°äºç­‰äº5æ—¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç 
        for (let i = 1; i <= total; i++) {
          pages.push(i);
        }
      } else {
        // æ˜¾ç¤ºå½“å‰é¡µé™„è¿‘çš„é¡µç 
        pages.push(1);
        
        if (current > 3) {
          pages.push(0); // çœç•¥å·
        }
        
        const start = Math.max(2, current - 1);
        const end = Math.min(total - 1, current + 1);
        
        for (let i = start; i <= end; i++) {
          pages.push(i);
        }
        
        if (current < total - 2) {
          pages.push(0); // çœç•¥å·
        }
        
        pages.push(total);
      }
      
      return pages;
    };

    // æ¸²æŸ“åˆ†é¡µæ§ä»¶
    const renderPagination = () => {
      if (paginationInfo.totalPages <= 1) {
        paginationContainer.classList.add('hidden');
        return;
      }
      
      paginationContainer.classList.remove('hidden');
      const visiblePages = getVisiblePages();
      
      paginationContainer.innerHTML = visiblePages.map(page => {
        const isActive = page === paginationInfo.currentPage;
        const isEllipsis = page === 0;
        const isDisabled = page === 0 || page > paginationInfo.totalPages;
        
        let className = 'px-3 py-1 mx-1 rounded text-sm';
        if (isActive) {
          className += ' bg-blue-500 text-white';
        } else if (!isDisabled) {
          className += ' bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700';
        } else {
          className += ' text-gray-400 cursor-not-allowed';
        }
        
        return `
          <button 
            ${isDisabled ? 'disabled' : ''}
            class="${className}"
            data-page="${page}"
            ${isDisabled ? '' : 'onclick="window.__localSearch.goToPage(' + page + ')"'}
          >
            ${isEllipsis ? '...' : page}
          </button>
        `;
      }).join('');
    };

    // æ¸²æŸ“æœç´¢ç»“æœ
    const renderSearchResults = () => {
      resultsList.innerHTML = '';
      
      searchResults.forEach((hit, index) => {
        const isActive = index === currentResultIndex;
        const link = getResultLink(hit);
        
        const resultItem = document.createElement('div');
        resultItem.className = `flex items-start p-3 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors group ${isActive ? 'bg-blue-50 dark:bg-blue-900/20' : ''}`;
        resultItem.setAttribute('data-index', index);
        
        let resultHtml = '';
        
        // æ·»åŠ å°é¢å›¾ç‰‡
        if (hit.cover && hit.cover.trim() !== '') {
          resultHtml += `
            <div class="mr-3 flex-shrink-0">
              <img
                src="${hit.cover}"
                alt="${hit.title}"
                class="w-16 h-12 object-cover rounded"
              />
            </div>
          `;
        }
        
        resultHtml += `
          <div class="flex-1 min-w-0">
            <h3 class="font-medium text-gray-900 dark:text-white truncate group-hover:text-blue-600 dark:group-hover:text-blue-400">
              ${renderHighlightedTitle(hit, searchQuery)}
            </h3>
            ${hit.content ? `
              <p class="mt-1 text-sm text-gray-600 dark:text-gray-400 line-clamp-2">
                ${renderHighlightedContent(hit, searchQuery)}
              </p>
            ` : ''}
            <div class="mt-2 flex items-center text-xs text-gray-500 dark:text-gray-500">
              ${hit.categories ? `
                <span class="mr-3">
                  ğŸ“‚ ${formatCategories(hit.categories)}
                </span>
              ` : ''}
              ${hit.tags ? `
                <div class="flex flex-wrap gap-1">
                  ${formatTags(hit.tags).map(tag => `
                    <span class="bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 px-2 py-0.5 rounded-full">
                      #${tag}
                    </span>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          </div>
        `;
        
        resultItem.innerHTML = resultHtml;
        resultItem.addEventListener('click', () => selectResult(hit));
        resultItem.addEventListener('mouseenter', () => currentResultIndex = index);
        
        resultsList.appendChild(resultItem);
      });
    };

    // è·å–ç»“æœé“¾æ¥
    const getResultLink = (hit) => {
      // ç¡®å®šcollectionç±»å‹
      const collection = hit.collection || hit._collection || 'articles';
      
      if (hit.permalink) {
        // å¦‚æœæœ‰æ°¸ä¹…é“¾æ¥ï¼Œç›´æ¥ä½¿ç”¨
        return hit.permalink.startsWith('/') ? hit.permalink : `/${hit.permalink}`;
      } else if (hit.route) {
        // å¦‚æœæœ‰routeå­—æ®µï¼Œä½¿ç”¨å®ƒ
        return hit.route;
      } else if (hit.url) {
        // å¦‚æœæœ‰urlå­—æ®µï¼Œä½¿ç”¨å®ƒ
        return hit.url;
      } else {
        // å¦åˆ™ä½¿ç”¨åŸºäºcollectionå’Œslugçš„è·¯å¾„
        return `/${collection}/${hit.slug}`;
      }
    };

    // é€‰æ‹©æŒ‡å®šç»“æœ
    const selectResult = (hit) => {
      window.location.href = getResultLink(hit);
    };

    // é€‰æ‹©å½“å‰ç»“æœ
    const selectCurrentResult = () => {
      if (currentResultIndex >= 0 && currentResultIndex < searchResults.length) {
        selectResult(searchResults[currentResultIndex]);
      }
    };

    // èšç„¦ä¸‹ä¸€ä¸ªç»“æœ
    const focusNextResult = () => {
      if (searchResults.length === 0) return;
      
      if (currentResultIndex < searchResults.length - 1) {
        currentResultIndex++;
      } else {
        currentResultIndex = 0;
      }
      
      // é‡æ–°æ¸²æŸ“ç»“æœä»¥æ›´æ–°é«˜äº®
      renderSearchResults();
      // æ»šåŠ¨åˆ°å½“å‰é«˜äº®ç»“æœ
      scrollToActiveResult();
    };

    // èšç„¦ä¸Šä¸€ä¸ªç»“æœ
    const focusPrevResult = () => {
      if (searchResults.length === 0) return;
      
      if (currentResultIndex > 0) {
        currentResultIndex--;
      } else {
        currentResultIndex = searchResults.length - 1;
      }
      
      // é‡æ–°æ¸²æŸ“ç»“æœä»¥æ›´æ–°é«˜äº®
      renderSearchResults();
      // æ»šåŠ¨åˆ°å½“å‰é«˜äº®ç»“æœ
      scrollToActiveResult();
    };

    // æ»šåŠ¨åˆ°å½“å‰æ¿€æ´»çš„ç»“æœ
    const scrollToActiveResult = () => {
      setTimeout(() => {
        const activeElement = document.querySelector('.search-results-state .bg-blue-50, .search-results-state .bg-blue-900\/20');
        if (activeElement) {
          activeElement.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
      }, 50);
    };

    // åˆ‡æ¢æœç´¢å¼¹çª—
    const toggleSearch = () => {
      isOpen = !isOpen;
      
      if (isOpen) {
        searchModal.classList.remove('hidden');
        // æ·»åŠ è¿‡æ¸¡æ•ˆæœ
        setTimeout(() => {
          searchModal.style.opacity = '1';
        }, 10);
        setTimeout(() => {
          searchInput.focus();
        }, 100);
      } else {
        searchModal.style.opacity = '0';
        setTimeout(() => {
          searchModal.classList.add('hidden');
          resetSearch();
        }, 200);
      }
    };

    // å…³é—­æœç´¢
    const closeSearch = () => {
      if (isOpen) {
        toggleSearch();
      }
    };

    // é‡ç½®æœç´¢çŠ¶æ€
    const resetSearch = () => {
      searchQuery = '';
      searchInput.value = '';
      searchResults = [];
      currentResultIndex = -1;
      currentPage = 1;
      paginationInfo = {
        currentPage: 1,
        totalPages: 0,
        hitsPerPage: 5,
        nbHits: 0
      };
      
      // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
      showInitialState();
    };

    // æ¸…é™¤æœç´¢
    const clearSearch = () => {
      searchQuery = '';
      searchInput.value = '';
      searchResults = [];
      currentResultIndex = -1;
      currentPage = 1;
      searchInput.focus();
      showInitialState();
    };

    // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
    const showInitialState = () => {
      initialState.classList.remove('hidden');
      loadingState.classList.add('hidden');
      resultsState.classList.add('hidden');
      noResultsState.classList.add('hidden');
    };

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const showLoadingState = () => {
      initialState.classList.add('hidden');
      loadingState.classList.remove('hidden');
      resultsState.classList.add('hidden');
      noResultsState.classList.add('hidden');
    };

    // æ˜¾ç¤ºç»“æœçŠ¶æ€
    const showResultsState = () => {
      initialState.classList.add('hidden');
      loadingState.classList.add('hidden');
      resultsState.classList.remove('hidden');
      noResultsState.classList.add('hidden');
      
      // æ›´æ–°ç»“æœè®¡æ•°å’ŒæŸ¥è¯¢æ˜¾ç¤º
      resultsCount.textContent = `æ‰¾åˆ° ${paginationInfo.nbHits} ä¸ªç»“æœ`;
      searchQueryDisplay.textContent = searchQuery;
      
      // æ¸²æŸ“æœç´¢ç»“æœ
      renderSearchResults();
      
      // æ¸²æŸ“åˆ†é¡µæ§ä»¶
      renderPagination();
    };

    // æ˜¾ç¤ºæ— ç»“æœçŠ¶æ€
    const showNoResultsState = () => {
      initialState.classList.add('hidden');
      loadingState.classList.add('hidden');
      resultsState.classList.add('hidden');
      noResultsState.classList.remove('hidden');
      
      // æ›´æ–°æ— ç»“æœæŸ¥è¯¢æ˜¾ç¤º
      noResultsQuery.textContent = searchQuery;
    };

    // åŠ è½½æ¨¡æ‹Ÿæœç´¢ç»“æœ
    const loadMockResults = async () => {
      try {
        const response = await fetch('/data.json');
        const allDocs = await response.json();
        
        // ç®€å•çš„æœç´¢è¿‡æ»¤
        const filteredDocs = allDocs.filter(doc => 
          (doc.title && doc.title.toLowerCase().includes(searchQuery.toLowerCase())) ||
          (doc.content && doc.content.toLowerCase().includes(searchQuery.toLowerCase())) ||
          (doc.tags && String(doc.tags).toLowerCase().includes(searchQuery.toLowerCase()))
        );
        
        // åˆ†é¡µå¤„ç†
        const startIndex = (currentPage - 1) * paginationInfo.hitsPerPage;
        const endIndex = startIndex + paginationInfo.hitsPerPage;
        const paginatedDocs = filteredDocs.slice(startIndex, endIndex);
        
        searchResults = paginatedDocs;
        paginationInfo = {
          currentPage: currentPage,
          totalPages: Math.ceil(filteredDocs.length / paginationInfo.hitsPerPage),
          hitsPerPage: paginationInfo.hitsPerPage,
          nbHits: filteredDocs.length
        };
        
        if (filteredDocs.length > 0) {
          showResultsState();
        } else {
          showNoResultsState();
        }
      } catch (err) {
        console.error('è·å–æ¨¡æ‹Ÿæ•°æ®å¤±è´¥:', err);
        // å¦‚æœè·å–data.jsonå¤±è´¥ï¼Œä½¿ç”¨ç®€å•çš„æ¨¡æ‹Ÿæ•°æ®
        searchResults = [
          {
            objectID: 'mock-1',
            title: `æ¨¡æ‹Ÿç»“æœ 1 - ${searchQuery}`,
            content: `è¿™æ˜¯ä¸"${searchQuery}"ç›¸å…³çš„æ¨¡æ‹Ÿç»“æœå†…å®¹ã€‚`,
            slug: 'mock-result-1',
            categories: ['æ–‡æ¡£'],
            tags: ['ç¤ºä¾‹', 'æœç´¢']
          },
          {
            objectID: 'mock-2',
            title: `æ¨¡æ‹Ÿç»“æœ 2 - ${searchQuery}`,
            content: `è¿™æ˜¯ç¬¬äºŒä¸ªæ¨¡æ‹Ÿç»“æœï¼Œå±•ç¤ºäº†å¦‚ä½•å¤„ç†æœç´¢å…³é”®è¯"${searchQuery}"ã€‚`,
            slug: 'mock-result-2',
            categories: ['æŒ‡å—'],
            tags: ['æ•™ç¨‹', 'ç¤ºä¾‹']
          }
        ];
        
        paginationInfo = {
          currentPage: 1,
          totalPages: 1,
          hitsPerPage: 5,
          nbHits: 2
        };
        
        showResultsState();
      }
    };

    // æœç´¢å¤„ç†å‡½æ•°
    const handleSearch = async () => {
      searchQuery = searchInput.value.trim();
      
      if (!searchQuery) {
        clearSearch();
        return;
      }

      isSearching = true;
      currentResultIndex = -1;
      currentPage = 1;
      
      try {
        showLoadingState();
        await loadMockResults();
      } catch (error) {
        console.error('æœç´¢å¤±è´¥:', error);
        searchResults = [];
        showNoResultsState();
      } finally {
        isSearching = false;
      }
    };

    // åˆ†é¡µå¤„ç†
    const goToPage = async (page) => {
      if (page === paginationInfo.currentPage || page < 1 || page > paginationInfo.totalPages) {
        return;
      }
      
      isSearching = true;
      currentResultIndex = -1;
      currentPage = page;
      
      try {
        showLoadingState();
        await loadMockResults();
      } catch (error) {
        console.error('åˆ†é¡µåŠ è½½å¤±è´¥:', error);
      } finally {
        isSearching = false;
      }
    };

    // é”®ç›˜äº‹ä»¶å¤„ç†
    const handleKeyDown = (e) => {
      // å¤„ç†Tabé”®
      if (e.key === 'Tab') {
        e.preventDefault();
        focusNextResult();
      }
    };

    // å…¨å±€é”®ç›˜å¿«æ·é”®å¤„ç†
    const handleGlobalKeydown = (e) => {
      // Cmd/Ctrl + K æ‰“å¼€æœç´¢
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        toggleSearch();
      }
      
      // å…¨å±€ESCé”®å…³é—­
      if (e.key === 'Escape' && isOpen) {
        e.preventDefault();
        closeSearch();
      }
    };

    // ä¸ºwindowå¯¹è±¡æ·»åŠ å…¬å¼€æ–¹æ³•ï¼Œä»¥ä¾¿åˆ†é¡µæŒ‰é’®è°ƒç”¨
    window.__localSearch = {
      goToPage: goToPage
    };

    // äº‹ä»¶ç›‘å¬å™¨
    if (searchToggle) {
      searchToggle.addEventListener('click', toggleSearch);
    }
    
    if (searchClose) {
      searchClose.addEventListener('click', closeSearch);
    }
    
    if (searchClear) {
      searchClear.addEventListener('click', clearSearch);
    }
    
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        // é˜²æŠ–å¤„ç†
        const timeoutId = setTimeout(handleSearch, 300);
        return () => clearTimeout(timeoutId);
      });
      
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeSearch();
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          focusNextResult();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          focusPrevResult();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          selectCurrentResult();
        } else {
          handleKeyDown(e);
        }
      });
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
    if (searchModal) {
      searchModal.addEventListener('click', (e) => {
        if (e.target === searchModal) {
          closeSearch();
        }
      });
    }
    
    // å…¨å±€é”®ç›˜äº‹ä»¶
    document.addEventListener('keydown', handleGlobalKeydown);
  })();
</script>

<style>
/* æœç´¢å¼¹çª—è¿‡æ¸¡åŠ¨ç”» */
#local-search-modal {
  opacity: 0;
  transition: opacity 0.2s ease;
}

#local-search-modal:not(.hidden) {
  opacity: 1;
}

/* æœç´¢ç»“æœå®¹å™¨æ ·å¼ */
.search-results-state {
  max-height: calc(60vh - 6rem);
  min-height: 200px;
}

/* é«˜äº®æ–‡æœ¬æ ·å¼ */
mark {
  background-color: #fde047;
  color: #000;
  font-weight: 500;
  border-radius: 0.25rem;
  padding: 0.125rem 0.25rem;
}

/* æš—è‰²æ¨¡å¼ä¸‹çš„é«˜äº®æ ·å¼ */
.dark mark {
  background-color: rgba(253, 224, 71, 0.3);
  color: #fde047;
}

/* å›¾ç‰‡æ ·å¼ */
.search-results-state img {
  border-radius: 0.375rem;
  object-fit: cover;
  background-color: #f9fafb;
}

.dark .search-results-state img {
  background-color: #1f2937;
}

/* æ ‡ç­¾æ ·å¼ */
.search-results-state .bg-blue-50 {
  background-color: #eff6ff;
}

.search-results-state .text-blue-700 {
  color: #1d4ed8;
}

.dark .search-results-state .bg-blue-900\/30 {
  background-color: rgba(30, 58, 138, 0.3);
}

.dark .search-results-state .text-blue-400 {
  color: #60a5fa;
}

/* åˆ†é¡µæ§ä»¶æ ·å¼ */
.search-results-state button:disabled {
  cursor: not-allowed;
}

/* é”®ç›˜å¿«æ·é”®æ ·å¼ */
kbd {
  font-family: SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  font-size: 0.75rem;
  line-height: 1.25;
  padding: 0.125rem 0.375rem;
  background-color: #f3f4f6;
  border: 1px solid #e5e7eb;
  border-radius: 0.25rem;
  box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  color: #1f2937;
}

.dark kbd {
  background-color: #374151;
  border-color: #4b5563;
  color: #d1d5db;
  box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.2);
}

/* æ»šåŠ¨æ¡æ ·å¼ä¼˜åŒ– */
.search-results-state::-webkit-scrollbar,
.search-no-results::-webkit-scrollbar,
.search-initial-state::-webkit-scrollbar,
.search-loading-state::-webkit-scrollbar {
  width: 6px;
}

.search-results-state::-webkit-scrollbar-track,
.search-no-results::-webkit-scrollbar-track,
.search-initial-state::-webkit-scrollbar-track,
.search-loading-state::-webkit-scrollbar-track {
  background: transparent;
}

.search-results-state::-webkit-scrollbar-thumb,
.search-no-results::-webkit-scrollbar-thumb,
.search-initial-state::-webkit-scrollbar-thumb,
.search-loading-state::-webkit-scrollbar-thumb {
  background-color: #d1d5db;
  border-radius: 3px;
}

.dark .search-results-state::-webkit-scrollbar-thumb,
.dark .search-no-results::-webkit-scrollbar-thumb,
.dark .search-initial-state::-webkit-scrollbar-thumb,
.dark .search-loading-state::-webkit-scrollbar-thumb {
  background-color: #4b5563;
}
</style>
